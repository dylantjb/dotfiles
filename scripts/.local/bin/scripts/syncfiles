#!/bin/sh

eval "$(grep -h -- \
  "^\s*\(export \)\?\(RCLONE_PASSWORD_COMMAND\|PASSWORD_STORE_DIR\)=" \
  "$HOME/.config/zsh/.zprofile" 2>/dev/null)"

rclone bisync "$@" || rclone bisync "$@" --resync

[ -d "$1" ] && cd "$1"
for i in *..path1; do ! [ "$i" = '*..path1' ] && {
  file="$(echo "$i" | sed 's/..path1//')"
  [ "${file##*.}" = "kdbx" ] && keepassxc-cli merge "$i" "$file..path2" && mv "$file..path1" "$file" || {
    diff -DVERSION1 "$file"..path? > "$file.merge"
    grep -v '^#if' "$file.merge" | grep -v '^#else' | grep -v '^#endif' > "$file"
    rm "$file"..path? "$file.merge"
  }
}; done
